- name: Render janus-gateway config templates
  become: true
  ansible.builtin.template:
    mode: 0660
    src: "{{ item.value }}"
    dest: "{{ janus_conf_dir }}/{{ item.value }}"
    owner: "{{ janus_user }}"
    force: true
    backup: true
  with_dict: "{{ janus_conf_template }}"
  when: ansible_local.license.janus_admin_secret is defined

- name: Render {{ janus_env_file }}
  become: true
  ansible.builtin.template:
    mode: 0660
    src: "systemd/janus.env.j2"
    dest: "{{ janus_env_file }}"
    owner: "{{ janus_user }}"
    force: true
    backup: true
  when: ansible_local.license.janus_admin_secret is defined

- name: Create janus.service from template and backout if validation fails
  block:
    - name: Update /etc/systemd/system/janus.service
      ansible.builtin.template:
        mode: 0644
        src: systemd/janus.service.j2
        dest: /etc/systemd/system/janus.service
        force: true
        backup: true
      register: updated
    - name: Run validation. We assume it returns an error when not passing, use `failed_when` if otherwise.
      become: true
      ansible.builtin.command: systemd-analyze verify {{ updated['dest'] }}

  rescue:
    - name: Restore backup file to original
      ansible.builtin.copy:
        remote_src: true
        dest: /etc/systemd/system/janus.service
        src: "{{ updated.backup_file }}"
        mode: 0664
      when: updated.backup_file is defined
  always:
    - name: We choose to always delete backup, but could copy or move, or only delete in rescue.
      ansible.builtin.file:
        path: "{{ updated.backup_file }}"
        state: absent
      when: updated.backup_file is defined
  notify:
    - reload janus service
