# Build libnice
- name: 'Create {{ janus_build_dir.path }}/venv'
  ansible.builtin.pip:
    name:
      - 'pip>21,<22'
      - setuptools
      - wheel
    virtualenv_command: /usr/bin/python3 -m venv
    virtualenv: '{{ janus_build_dir.path }}/venv'
    extra_args: '--no-cache-dir'
  tags:
    - janus
    - setup
    - auto_update
- include_tasks: build/sources.yml
# first parallelizable stage of each component build
- include_tasks: build/build_async.yml
- name: Configure - janus build
  command:
    cmd: "./configure \
      --prefix={{ janus_install_dir }} \
      {{ janus_build_extras.rabbitmq | ternary('', '--disable-rabbitmq') }} \
      {{ janus_build_extras.mqtt | ternary('', '--disable-mqtt') }} \
      {{ janus_build_extras.websockets | ternary('', '--disable-websockets') }} \
      {{ janus_build_extras.nanomsg | ternary('', '--disable-nanomsg') }} \
      {{ janus_build_extras.systemd | ternary('--enable-systemd-sockets', '') }} \
      {{ janus_build_extras.recordplay | ternary('', '--disable-plugin-recordplay') }} \
      {{ janus_build_extras.sip | ternary('', '--disable-plugin-sip') }}"
    chdir: "{{ janus_build_dir.path }}/build"
  when: janus_upgrade_available
- name: Build - janus
  become: true
  command:
    cmd: make
    chdir: "{{ janus_build_dir.path }}/build"
  when: janus_upgrade_available

- name: Install - janus
  become: true
  command:
    cmd: make install
    chdir: "{{ janus_build_dir.path }}/build"
  when: janus_upgrade_available

- name: Set installed version facts
  ansible.builtin.set_fact:
    janus_version: "{{ janus_version }}"
    janus_libnice_version: "{{ janus_libnice_version }}"
    janus_usrsctp_version: "{{ janus_usrsctp_version }}"
    janus_libsrtp_version: "{{ janus_libsrtp_version }}"
    janus_libwebsockets_version: "{{ janus_libwebsockets_version }}"
    cacheable: true

- name: "Delete {{ janus_build_dir.path }} build directory"
  become: true
  ansible.builtin.file:
    path: "{{ janus_build_dir.path }}"
    state: absent
  when: janus_upgrade_available

- name: "Delete {{ janus_libwebsockets_build_dir.path }} build directory"
  become: true
  ansible.builtin.file:
    path: "{{ janus_libwebsockets_build_dir.path }}"
    state: absent
  when: janus_upgrade_available

- name: "Delete {{ janus_libnice_build_dir.path }} build directory"
  become: true
  ansible.builtin.file:
    path: "{{ janus_libnice_build_dir.path }}"
    state: absent
  when: janus_upgrade_available

- name: "Delete {{ janus_libsrtp_build_dir.path }} build directory"
  become: true
  ansible.builtin.file:
    path: "{{ janus_libsrtp_build_dir.path }}"
    state: absent
  when: janus_upgrade_available

- name: "Delete {{ janus_usrsctp_build_dir.path }} build directory"
  become: true
  ansible.builtin.file:
    path: "{{ janus_usrsctp_build_dir.path }}"
    state: absent
  when: janus_upgrade_available
